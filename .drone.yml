---
kind: pipeline
name: CI

services:
  - name: meilisearch
    image: getmeili/meilisearch:v0.29.0
    environment:
      MEILI_MASTER_KEY: "m3i7i3"

steps:
  - name: test
    image: rust:latest
    environment:
      MEILI_HTTP_ADDR: "meilisearch:7700"
      MEILI_URI: "http://meilisearch:7700"
      MEILI_MASTER_KEY: "m3i7i3"
      MEILI_ADMIN_KEY: "75f9a9c8fd10f27032db9b0982142b23f1fc57cbd48ae464e69e85a211d47352"  # yamllint disable-line rule:line-length
      TAG_FILE: "./job_tags.txt"
    commands:
      - apt-get update
      - apt-get install -y yamllint jq
      - yamllint ./.drone.yml
      - 'export MEILI_ADMIN_KEY = $(curl http://meilisearch:7700/keys -H "Authorization: Bearer m3i7i3" | jq ".results[] | select(.name == \"Default Admin API Key\") | .key")'  # yamllint disable-line rule:line-length
      - cd bot
      - cargo check --verbose
      - cargo test --verbose

  - name: build
    image: rust:latest
    volumes:
      - name: target
        path: /target
    commands:
      - cd bot
      - cargo build --release --verbose --target-path /target

  - name: deploy-bot
    image: drillster/drone-rsync
    settings:
      hosts:
        from_secret: DEPLOY_HOSTS
      user:
        from_secret: DEPLOY_USER
      key:
        from_secret: DEPLOY_KEY
      source: /target/release/
      target: /u/apps/hunter2/
      include: ["hunter2"]
      script:
        - ssh ${DEPLOYTO} chmod +x /usr/local/bin/hunter2
        - sudo systemctl restart hunter2.service

  - name: deploy-tagfile
    image: drillster/drone-rsync
    settings:
      hosts:
        from_secret: DEPLOY_HOSTS
      user:
        from_secret: DEPLOY_USER
      key:
        from_secret: DEPLOY_KEY
      source: ./bot/
      target: /u/apps/hunter2/
      include: ["job_tags.txt"]
      script:
        - sudo systemctl restart hunter2.service

  - name: deploy-web
    image: drillster/drone-rsync
    settings:
      hosts:
        from_secret: DEPLOY_HOSTS
      user:
        from_secret: DEPLOY_USER
      key:
        from_secret: DEPLOY_KEY
      source: ./web/
      target: /u/apps/flockingbird_jobsearch/current/public/
