---
kind: pipeline
name: CI

services:
  meilisearch:
    image: getmeili/meilisearch:v0.29.0
    ports:
      - 7701:7700

steps:
  - name: test
    image: rust:latest-bullseye
    environment:
      TAG_FILE: "./job_tags.txt"

    commands:
      - sudo apt-get update
      - sudo apt-get install -y yamllint
      - yamllint ./.github/workflows/*.yml
      - cd bot && cargo check --verbose
      - cd bot && cargo test --verbose

  - name: build
    image: rust:latest-bullseye
    volumes:
      - name: target
        path: /target
    commands: 
      - cd bot && cargo build --release --verbose --target-path /target

  - name: deploy-bot
    image: drillster/drone-rsync
    settings:
      hosts:
        from_secret: DEPLOY_HOSTS
      user:
        from_secret: DEPLOY_USER
      key:
        from_secret: DEPLOY_KEY
      source: /target/release/
      target: /u/apps/hunter2/
      include: ["hunter2"]
      script: 
        - ssh ${DEPLOYTO} chmod +x /usr/local/bin/hunter2
        - sudo systemctl restart hunter2.service

  - name: deploy-tagfile
    image: drillster/drone-rsync
    settings:
      hosts:
        from_secret: DEPLOY_HOSTS
      user:
        from_secret: DEPLOY_USER
      key:
        from_secret: DEPLOY_KEY
      source: ./bot/
      target: /u/apps/hunter2/
      include: ["job_tags.txt"]
      script: 
        - sudo systemctl restart hunter2.service

  - name: deploy-web
    image: drillster/drone-rsync
    settings:
      hosts:
        from_secret: DEPLOY_HOSTS
      user:
        from_secret: DEPLOY_USER
      key:
        from_secret: DEPLOY_KEY
      source: ./web/
      target: /u/apps/flockingbird_jobsearch/current/public/
