<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Flockingbird - Search</title>
    <link rel="stylesheet" href="/css/vendor/bulma.min.css">
    <link rel="stylesheet" href="/css/vendor/materialdesignicons.min.css">
    <link rel="stylesheet" href="/css/application.css">
    <script src='https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.js'></script>
    <script charset="utf-8">
      const ignoredCommonTags = ['job', 'jobs', 'jobsearch', 'joboffer', 'hiring', 'vacancy', 'offredemploi', 'emploi', 'jobangebot', 'fedihire']; 
      const meiliSearchHost = 'https://meili.flockingbird.social';
      const meiliSearchPubApiKey = 'WBHjcemG40873580ee15b9f215f352bcd923fc2fb95bb3a51dc754000f9cf98cd235680e'
      const perPage = 20;
      const client = new MeiliSearch({
        host: meiliSearchHost,
        apiKey: meiliSearchPubApiKey,
      });
      const index = client.index('vacancies');

      document.addEventListener('DOMContentLoaded', () => {
        (document.querySelectorAll('.notification .delete') || []).forEach(($delete) => {
          var $notification = $delete.parentNode;

          $delete.addEventListener('click', () => {
            $notification.parentNode.removeChild($notification);
          });
        });

        const searchForm = document.getElementById('search-form');
        searchForm.addEventListener('submit', function(event) {
          event.preventDefault();
          doSearch().then(handleSearchResponse);
        });

        prefillDefault();
      });

      const getActiveTags = function() {
        const activeNodes = document.getElementById('active-tags')
                                    .querySelectorAll('.list-item');
        return Array.from(activeNodes).map((li) => li.dataset.tagName)
      };

      const prefillDefault = function() {
        const defaultAmount = 10;
        const defaultSort = 'created_at_ts:desc';

        index.search(null, { limit: defaultAmount, sort: [defaultSort] })
          .then(function(result) {
            setHeading('Latest job openings on the fediverse.');
            insertHits(result.hits);
          });
      };

      const handleNextPage = function(result, offset) {
        removePager();

        insertHits(result.hits)

        if (!result.exhaustiveNbHits) { // TODO: exhaustiveNbHits does not work as expected on next pages. The button will stay in place.
          insertPager(offset + perPage);
        }
      }

      const handleSearchResponse = function(result) {
          if (result.query) {
            setHeading(`Job openings for ${result.query}`);
          }

          if (result.facetsDistribution) {
            const tags = extractFacetTags(result)
              .filter(notCommonName)
              .filter(notSpammy)
              .sort(sortByCount)
            replaceTags(tags);
          }

          replaceHits(result.hits);

          if (!result.exhaustiveNbHits) { // TODO: exhaustiveNbHits does not work as expected on next pages. The button will stay in place.
            insertPager(0 + perPage);
          }
      }

      const doSearch = function(offset = 0) {
        const query = document.getElementById('search-field').value;

        removePager();
        var options =  {
          offset: offset,
          limit: perPage,
          facetsDistribution: ['tags.name']
        }

        const filter = getActiveTags().map((tagName) => `tags.name = "${tagName}"`);
        if (filter.length > 0) {
          options.filter = filter;
        }

        return index.search(query, options);
      }

      const insertPager = function(offset) {
        const page_tmpl = document.getElementById('pager');
        const results_container = document.getElementById('results');
        var clone = page_tmpl.content.cloneNode(true);

        clone.firstElementChild.addEventListener('click', function(event) {
          event.preventDefault();
          doSearch(offset).then((result) => handleNextPage(result, offset));
        });
        results_container.appendChild(clone);
      };

      const removePager = function() {
        const container = document.getElementById('results');
        container.querySelectorAll('.pager').forEach(function(pager) {
          container.removeChild(pager);
        });
      };

      const setHeading = function(message) {
        const heading = document.getElementById('heading');
        heading.innerText = strip(message);
      };

      const replaceTags = function(filterTags) {
        const tag_tmpl = document.getElementById('refine-tag');
        const tagsContainer = document.getElementById('inactive-tags');
        const activeTags = getActiveTags();

        tagsContainer.innerHTML = '';

        filterTags.forEach((tag) => {
          if (activeTags.includes(tag.name)) { return; }

          var clone = tag_tmpl.content.cloneNode(true);
          var li = clone.querySelector('li');

          li.dataset.tagName = tag.name;
          li.querySelector('.name').innerText = tag.name;
          li.querySelector('.count').innerText = `(${tag.count})`;

          li.querySelector('a').addEventListener('click', handleRefine);

          tagsContainer.appendChild(li);
        });
        showTagsBlock();
      };

      const extractFacetTags = function(result) {
        const filterTags = result.facetsDistribution['tags.name'];
        return Object.keys(filterTags)
          .map((key) => { return { 'name': key, 'count': filterTags[key] }; })
      };

      const sortByCount = function(a, b) {
        return b.count - a.count;
      };

      const notCommonName = function(nameable) {
        return !ignoredCommonTags.includes(nameable.name);
      };

      // If the entire array is short, allow all tags,
      // otherwise, only return the tags that are used more than once.
      const notSpammy = function(tagPair, _index, allTags) {
        const tagLimit = 20;
        if (allTags.length < tagLimit) { return true; }
        
        return (tagPair.count > 1);
      };

      const removeHits = function() {
        const container = document.getElementById('results');
        container.querySelectorAll('article.media').forEach(function(hit) {
          container.removeChild(hit);
        });
      };

      const replaceHits = function(hits) {
         removeHits();
         insertHits(hits);
      };

      const insertHits = function(hits) {
        const hit_tmpl = document.getElementById('hit');
        const tag_tmpl = document.getElementById('tag');
        const results_container = document.getElementById('results');

        hits.forEach(function(hit, _index, _array) {
          var clone = hit_tmpl.content.cloneNode(true);

          clone.querySelector('.excerpt').innerHTML = hit.content;
          clone.querySelector('.name').innerText = hit.account.display_name;
          clone.querySelector('.handle').innerText = hit.account.acct;

          var date = Date.parse(hit.created_at);
          clone.querySelector('.date').innerText = Intl.DateTimeFormat().format(date);

          clone.querySelector('.avatar').src = hit.account.avatar;
          clone.querySelectorAll('.toot-link').forEach(function(link) {
            link.href = hit.url;
          });
          clone.querySelector('.full-url a.toot-link span.link').innerText = hit.url;

          results_container.append(clone);
        });
      };

      const handleRefine = function(event) {
          event.preventDefault();
          toggleActive(event.currentTarget.parentNode);
          doSearch().then(handleSearchResponse);
      }

      const toggleActive = function(element) {
          const activeTagsContainer = document.getElementById('active-tags');
          const inactiveTagsContainer = document.getElementById('inactive-tags');

          if (element.classList.contains('is-active')) {
            element.remove();
          } else {
            element.querySelector('.count').innerText = "";
            activeTagsContainer.appendChild(element);
          }

          element.classList.toggle('is-active');
      };

      const showTagsBlock = function() {
        document.getElementById('tags-container').classList.remove('is-hidden');
      };

      const strip = function(str) {
         const doc = new DOMParser().parseFromString(str, 'text/html');
         return doc.body.textContent || '';
      };
   </script>
  </head>

  <body>
    <section class="hero">
      <div class="hero-head pb-0 pt-6 is-brand-bg">
        <div class="columns is-vcentered">
          <div class="column is-logo is-2 is-flex is-justify-content-center">
            <h1 class="title">Flockingbird - Search</h1>
            <img src="/images/search.png" alt="FlockingBird">
          </div>
          <div class="column is-8">
            <form id="search-form">
              <div class="field has-addons">
                <div class="control is-expanded">
                  <input type="search" id="search-field" class="input is-large is-rounded" placeholder="Search job openings on the fediverse hereâ€¦"/>
                </div>
                <div class="control">
                  <button class="button is-large is-rounded is-brand-color">
                    <span class="icon is-large">
                      <span class="mdi mdi-36px mdi-magnify"></span>
                    </span>
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div class="column is-2"></div>
        </div>

        <div class="columns">
          <div class="column is-2">
          </div>
          <div class="column is-8">
          </div>
          <div class="column is-2"></div>
        </div>
      </div>

      <div class="hero-body px-0">
        <div class="columns" id="container">
          <div class="column is-2">
          </div>
          <div id="results" class="column is-5">
            <h2 id="heading" class="title"/>
          </div>
          <div class="column is-3">
            <section class="mb-6 card is-brand-shadowed is-hidden" id="tags-container">
              <div class="card-content">
                <h1 class="title">Refine your search:</h1>
                <div class="menu">
                  <ul class="menu-list" id="active-tags"></ul>
                  <ul class="menu-list" id="inactive-tags"></ul>
                </div>
              </div>
            </section>

            <section class="card is-brand-shadowed">
              <div class="card-content">
                <h1 class="title">Help improve these results!</h1>
                <p class="content">
                Didn't find the results you were looking for? Flockingbird is in
                beta and we are still actively developing and refining the
                software.  Join the discussion in
                <a class="is-brand-color has-text-weight-semibold" href="https://github.com/Flockingbird/roost/issues/42">community chat</a>
                or jump into our
                <a class="is-brand-color has-text-weight-semibold" href="https://github.com/Flockingbird">Github repo</a>
                and post your feedback.
                </p>
              </div>
            </section>

            <section class="mt-6 card is-brand-shadowed">
              <div class="card-content">
                <h1 class="title">Your vacancy here?</h1>
                <p class="content">
                Just use the tag <strong>#vacancy</strong> in your update and we'll pick it up the moment we see it on the fediverse.
                </p>
                <p>But be sure that your account allows indexing by bots. We respect those settings and won't index a vacancy if your account does not allow it</p>
              </div>
            </section>
          </div>
          <div class="column is-2">
          </div>
        </div>
      </div>
    </section>

    <template id="hit">
      <article class="media p-3">
        <figure class="media-left">
          <p class="image is-128x128 is-brand-shadowed">
          <img class="avatar" src="">
          </p>
        </figure>
        <div class="media-content">
          <div class="content">
            <p><a href="" class="toot-link">
              <strong class="name"></strong>
              <small class="handle"></small>
              <small class="date"></small>
            </a></p>
            <p class="full-url">
            <a href="" class="toot-link is-brand-colored">
              <span class="icon is-small">
                <span class="mdi mdi-chevron-right-circle"></span>
              </span>
              <span class="link is-brand-color">
              </span>
            </a>
            </p>
            <p class="excerpt"></p>
            </p>
          </div>
        </div>
      </article>
    </template>
    <template id="tag">
      <span class="tag is-light">
        <a class="name"></a>
        <span class="icon">
          <span class="mdi mdi-magnify"></span>
        </span>
    </template>
    <template id="refine-tag">
      <li class="list-item" data-tag-name>
        <a class="refine">
          <span class="name"></span>
          <span class="count"></span>
        </a>
      </li>
    </template>
    <template id="pager">
      <button class="button is-medium is-fullwidth pager">More results</button>
    </template>
  </body>
</html>
